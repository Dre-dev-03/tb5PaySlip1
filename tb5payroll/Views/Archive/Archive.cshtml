@{
	Layout = "_DashboardLayout";
	ViewBag.Title = "Employee Archive";
}

<h2 class="text-left mb-4">Employee Archive</h2>

<div class="dashboard-controls mb-3">
	<!-- Search Input -->
	<input type="text" id="searchInput" class="form-control" placeholder="Search Archive..." onkeyup="searchArchive()">

	<!-- Date Range Picker -->
	<div class="input-group">
		<input type="date" id="startDate" class="form-control" placeholder="Start Date">
		<span class="input-group-text">to</span>
		<input type="date" id="endDate" class="form-control" placeholder="End Date">
		<button class="btn btn-primary" onclick="filterByDate()">Filter</button>
	</div>

	<!-- Bulk Delete Button -->
	<button id="deleteOldBtn" class="btn btn-danger ms-2" title="Delete records older than selected date">
		<i class="fas fa-trash"></i> Delete Old Records
	</button>
</div>

<!-- Archive Table -->
<div class="table-responsive" style="max-height: 370px; overflow-y: auto; border: 1px solid #ccc;">
	<table class="table table-sm table-bordered text-center" id="archiveTable" style="margin-bottom: 0; font-size: 17px;">
		<thead class="table-dark" style="background-color: skyblue;">
		<tr>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">ID No</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Name</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Archived Date</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Hours Worked</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Overtime</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Holiday</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Gross Pay</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Net Pay</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Actions</th>
		</tr>
		</thead>
		<tbody>
		<!-- Rows will be populated dynamically -->
		</tbody>
	</table>
</div>

<!-- Pagination Controls -->
<div class="d-flex justify-content-between mt-3">
	<button id="prevPage" class="btn btn-secondary" disabled>Previous</button>
	<span id="pageInfo">Page 1</span>
	<button id="nextPage" class="btn btn-secondary">Next</button>
</div>

<!-- Confirmation Modal for Deletion -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Confirm Deletion</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p id="deleteModalMessage">Are you sure you want to delete this record?</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
			</div>
		</div>
	</div>
</div>

<!-- Reuse the same details modal from Dashboard -->
@await Html.PartialAsync("_PayslipModal")

<style>
	html, body {
		height: 100%;
		margin: 0;
		display: flex;
		flex-direction: column;
	}

	.modal-body {
		overflow-x: auto;
		min-width: 100%;
	}

	.input-group-text {
		background-color: #e9ecef;
	}
</style>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		let currentPage = 0;
		const rowsPerPage = 7;
		const table = document.getElementById("archiveTable");
		const tbody = table.querySelector("tbody");
		let allRows = Array.from(tbody.rows);
		let filteredRows = [...allRows];
		let currentArchiveId = null;
		let currentCutoffDate = null;

		async function loadArchiveData() {
			const tableContainer = document.querySelector('.table-responsive');

			// Show loading overlay
			const overlay = document.createElement('div');
			overlay.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-light bg-opacity-75';
			overlay.style.zIndex = '10';
			overlay.innerHTML = '<div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div>';
			tableContainer.style.position = 'relative';
			tableContainer.appendChild(overlay);

			try {
				const response = await fetch('/Archive/GetArchiveData');
				const result = await response.json();

				if (!response.ok) {
					throw new Error(result.message || 'Failed to load archive data');
				}

				if (!result.success) {
					showEmptyState(result.message || 'No archive data available');
					return;
				}

				populateTable(result.data);
			} catch (error) {
				console.error("Error loading archive data:", error);
				showEmptyState(error.message || 'Failed to load archive data');
			} finally {
				overlay.remove();
			}
		}

		function populateTable(data) {
			tbody.innerHTML = "";
			data.forEach(record => {
				const row = document.createElement("tr");
				row.innerHTML = `
                    <td>${record.birthdayEmployeeData}</td>
                    <td><a href="#">${record.nameEmployeeData}</a></td>
                    <td>${new Date(record.employeeArchiveDate).toLocaleDateString()}</td>
                    <td>${record.hoursWorkedEmployeeData?.toFixed(1) || '0.0'}</td>
                    <td>${record.overtimeHoursEmployeeData?.toFixed(1) || '0.0'}</td>
                    <td>${record.holidayHoursEmployeeData?.toFixed(1) || '0.0'}</td>
                    <td>${calculateGrossPay(record).toFixed(2)}</td>
                    <td>${record.calculatedPayEmployeeData?.toFixed(2) || '0.00'}</td>
                    <td>
                        <button class="btn btn-primary btn-view">View</button>
                        <button class="btn btn-danger btn-delete" data-archiveid="${record.archiveId}">Delete</button>
                    </td>
                `;
				tbody.appendChild(row);
			});

			allRows = Array.from(tbody.rows);
			filteredRows = [...allRows];
			showPage(1);
		}

		function calculateGrossPay(record) {
			return (record.basePayEmployeeData * record.hoursWorkedEmployeeData) +
				(record.overtimeHoursEmployeeData * record.basePayEmployeeData * 1.25) +
				(record.holidayHoursEmployeeData * record.basePayEmployeeData * 2);
		}

		function showEmptyState(message) {
			tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <div class="text-muted">${message}</div>
                    </td>
                </tr>
            `;
			allRows = Array.from(tbody.rows);
			filteredRows = [...allRows];
			showPage(1);
		}

		function totalPages() {
			return Math.ceil(filteredRows.length / rowsPerPage);
		}

		function showPage(page) {
			tbody.innerHTML = "";
			const start = (page - 1) * rowsPerPage;
			const end = start + rowsPerPage;
			filteredRows.slice(start, end).forEach(row => tbody.appendChild(row));
			document.getElementById("pageInfo").innerText = `Page ${page} of ${totalPages()}`;
			document.getElementById("prevPage").disabled = page === 1;
			document.getElementById("nextPage").disabled = page === totalPages();
		}

		function searchArchive() {
			const searchInput = document.getElementById("searchInput").value.toLowerCase();
			filteredRows = allRows.filter(row =>
				Array.from(row.cells).some(cell => cell.innerText.toLowerCase().includes(searchInput))
			);
			currentPage = 1;
			showPage(currentPage);
		}

		async function filterByDate() {
			const startDate = document.getElementById("startDate").value;
			const endDate = document.getElementById("endDate").value;

			try {
				const response = await fetch(`/Archive/GetArchiveData?startDate=${startDate}&endDate=${endDate}`);
				const result = await response.json();

				if (!response.ok) {
					throw new Error(result.message || 'Failed to filter archive data');
				}

				populateTable(result.data);
			} catch (error) {
				console.error("Error filtering archive data:", error);
				alert('Error filtering archive data: ' + error.message);
			}
		}

		// Event listeners
		document.getElementById("searchInput").addEventListener("keyup", searchArchive);
		document.getElementById("prevPage").addEventListener("click", () => currentPage > 1 && showPage(--currentPage));
		document.getElementById("nextPage").addEventListener("click", () => currentPage < totalPages() && showPage(++currentPage));

		// View button click handler
		document.getElementById("archiveTable").addEventListener("click", function (event) {
			if (event.target.classList.contains("btn-view")) {
				const row = event.target.closest("tr");
				const employeeId = row.cells[0].innerText;
				const archiveDate = row.cells[2].innerText;

				fetch(`/Archive/GetArchiveDetails?id=${employeeId}&date=${archiveDate}`)
					.then(response => {
						if (!response.ok) throw new Error('Network response was not ok');
						return response.json();
					})
					.then(data => {
						// Same modal population as before
						const employeeName = data.nameEmployeeData || "Unknown Employee";
						document.getElementById("employeeName").innerText = employeeName;
						document.getElementById("receivedBy").innerText = employeeName;
						document.getElementById("holidayPay").innerText = (data.holidayHoursEmployeeData || 0).toFixed(2);

						const grossPay = calculateGrossPay(data);
						document.getElementById("grossPay").innerText = grossPay.toFixed(2);
						document.getElementById("netPay").innerText = (data.calculatedPayEmployeeData || 0).toFixed(2);
						document.getElementById("totalField").innerText = grossPay.toFixed(2);
						document.getElementById("taxField").innerText = (data.taxEmployeeData || 0).toFixed(2);
						document.getElementById("sssField").innerText = (data.sssEmployeeData || 0).toFixed(2);
						document.getElementById("philhealthField").innerText = (data.philHealthEmployeeData || 0).toFixed(2);
						document.getElementById("pagibigField").innerText = (data.pagIbigEmployeeData || 0).toFixed(2);
						document.getElementById("loanField").innerText = (data.loanEmployeeData || 0).toFixed(2);
						document.getElementById("hoursWorkedField").innerText = (data.hoursWorkedEmployeeData || 0).toFixed(2);

						// Calculate total deductions
						const totalDeductions = (data.sssEmployeeData || 0) + (data.philHealthEmployeeData || 0) +
							(data.pagIbigEmployeeData || 0) + (data.loanEmployeeData || 0) +
							(data.taxEmployeeData || 0);
						document.getElementById("totalDeductions").innerText = totalDeductions.toFixed(2);

						// Update date field to show archive date
						document.getElementById("dateField").innerText = new Date(data.employeeArchiveDate).toLocaleDateString();

						new bootstrap.Modal(document.getElementById("detailsModal")).show();
					})
					.catch(error => {
						console.error("Error:", error);
						const employeeName = row.cells[1].innerText || "Unknown Employee";
						document.getElementById("employeeName").innerText = employeeName;
						document.getElementById("receivedBy").innerText = employeeName;
						new bootstrap.Modal(document.getElementById("detailsModal")).show();
					});
			}
			else if (event.target.classList.contains("btn-delete")) {
				currentArchiveId = event.target.dataset.archiveid;
				const employeeName = event.target.closest("tr").cells[1].innerText;

				document.getElementById("deleteModalMessage").innerText =
					`Are you sure you want to delete the archive record for ${employeeName}?`;

				const deleteModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
				deleteModal.show();
			}
		});

		// Delete confirmation handler
		document.getElementById("confirmDeleteBtn").addEventListener("click", async function() {
			try {
				const response = await fetch('/Archive/DeleteArchiveRecord', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ archiveId: currentArchiveId })
				});

				const result = await response.json();

				if (!response.ok) {
					throw new Error(result.message || 'Failed to delete record');
				}

				if (result.success) {
					// Close modal and refresh data
					bootstrap.Modal.getInstance(document.getElementById("confirmDeleteModal")).hide();
					loadArchiveData();

					// Show success message
					if (typeof Swal !== 'undefined') {
						Swal.fire('Success!', 'Archive record deleted successfully', 'success');
					} else {
						alert('Archive record deleted successfully');
					}
				}
			} catch (error) {
				console.error("Error deleting archive record:", error);
				alert('Error deleting archive record: ' + error.message);
			}
		});

		// Delete old records handler
		document.getElementById("deleteOldBtn").addEventListener("click", function() {
			const cutoffDate = prompt("Enter cutoff date (YYYY-MM-DD). All records before this date will be deleted:");

			if (cutoffDate && confirm(`Are you sure you want to delete ALL records before ${cutoffDate}? This cannot be undone.`)) {
				fetch('/Archive/DeleteOldRecords', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ cutoffDate: cutoffDate })
				})
					.then(response => response.json())
					.then(result => {
						if (result.success) {
							loadArchiveData();
							if (typeof Swal !== 'undefined') {
								Swal.fire('Success!', result.message, 'success');
							} else {
								alert(result.message);
							}
						} else {
							throw new Error(result.message);
						}
					})
					.catch(error => {
						console.error("Error deleting old records:", error);
						alert('Error deleting old records: ' + error.message);
					});
			}
		});

		// Initial load
		loadArchiveData();
	});

	// Reuse the print function from Dashboard
	function printModalContent() {
		// Same implementation as in Dashboard.cshtml
	}
</script>