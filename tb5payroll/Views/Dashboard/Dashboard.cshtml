@{
	Layout = "_DashboardLayout";
	ViewBag.Title = "Dashboard";
}

<h2 class="text-left mb-4">Employee Dashboard</h2>

<!-- Search Bar -->
<div class="mb-3 d-flex justify-content-between">
	<input type="text" id="searchInput" class="form-control w-25" placeholder="Search Employee..." onkeyup="searchEmployee()">
	<button class="btn btn-primary">Print All</button>
	<input type="file" id="excelFileInput" class="form-control w-25" accept=".xlsx" />
	<select id="sheetSelect" class="form-select w-25" disabled>
		<option>Choose Sheet</option>
	</select>
</div>

<!-- Employee Table -->
<div class="table-responsive" style="max-height: 370px; overflow-y: auto; border: 1px solid #ccc;">
	<table class="table table-sm table-bordered text-center" id="employeeTable" style="margin-bottom: 0; font-size: 17px;">
		<thead class="table-dark" style="background-color: skyblue;">
		<tr>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">ID No</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Name</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Department</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Holiday</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Overtime</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Hours Worked</th>
			<th style="position: sticky; top: 0; z-index: 2; background: skyblue;">Actions</th>
		</tr>
		</thead>
		<tbody>
		<!-- Rows will be populated dynamically -->
		</tbody>
	</table>
</div>

<!-- Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="detailsModalLabel">Employee Deeets</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<!-- Updated Details Table -->
				<table class="table table-bordered">
					<thead class="table-light">
					<tr>
						<th>Employee Information</th>
						<th>Details</th>
					</tr>
					</thead>
					<tbody id="detailsTableBody">
					<!-- Dynamic content will be inserted here -->
					</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<!-- Pagination Controls -->
<div class="d-flex justify-content-between mt-3">
	<button id="prevPage" class="btn btn-secondary" disabled>Previous</button>
	<span id="pageInfo">Page 1</span>
	<button id="nextPage" class="btn btn-secondary">Next</button>
</div>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		let currentPage = 0;
		const rowsPerPage = 7;
		const table = document.getElementById("employeeTable");
		const tbody = table.querySelector("tbody");
		let allRows = Array.from(tbody.rows);
		let filteredRows = [...allRows];

		function totalPages() {
			return Math.ceil(filteredRows.length / rowsPerPage);
		}

		function showPage(page) {
			tbody.innerHTML = "";
			const start = (page - 1) * rowsPerPage;
			const end = start + rowsPerPage;
			filteredRows.slice(start, end).forEach(row => tbody.appendChild(row));
			document.getElementById("pageInfo").innerText = `Page ${page} of ${totalPages()}`;
			document.getElementById("prevPage").disabled = page === 1;
			document.getElementById("nextPage").disabled = page === totalPages();
		}

		function searchEmployee() {
			const searchInput = document.getElementById("searchInput").value.toLowerCase();
			filteredRows = allRows.filter(row =>
				Array.from(row.cells).some(cell => cell.innerText.toLowerCase().includes(searchInput))
			);
			currentPage = 1;
			showPage(currentPage);
		}

		document.getElementById("searchInput").addEventListener("keyup", searchEmployee);
		document.getElementById("prevPage").addEventListener("click", () => currentPage > 1 && showPage(--currentPage));
		document.getElementById("nextPage").addEventListener("click", () => currentPage < totalPages() && showPage(++currentPage));

		showPage(currentPage);

		// Handle View Button Click (Event Delegation)
		document.getElementById("employeeTable").addEventListener("click", function (event) {
			if (event.target.classList.contains("btn-view")) {
				const row = event.target.closest("tr");
				const detailsTableBody = document.getElementById("detailsTableBody");

				detailsTableBody.innerHTML = `
					<tr><td>ID</td><td>${row.cells[0].innerText}</td></tr>
					<tr><td>Name</td><td>${row.cells[1].innerText}</td></tr>
					<tr><td>Department</td><td>${row.cells[2].innerText}</td></tr>
					<tr><td>Holiday</td><td>${row.cells[3].innerText}</td></tr>
					<tr><td>Overtime</td><td>${row.cells[4].innerText}</td></tr>
					<tr><td>Hours Worked</td><td>${row.cells[5].innerText}</td></tr>
				`;

				new bootstrap.Modal(document.getElementById("detailsModal")).show();
			}
		});

		// Handle File Upload & Sheet Selection
		document.getElementById("excelFileInput").addEventListener("change", function (event) {
			const file = event.target.files[0];
			if (file) {
				const formData = new FormData();
				formData.append("file", file);

				fetch("/Dashboard/GetSheets", { method: "POST", body: formData })
					.then(response => response.json())
					.then(data => {
						const sheetSelect = document.getElementById("sheetSelect");
						sheetSelect.innerHTML = '<option>Choose Sheet</option>';
						data.forEach(sheet => {
							const option = document.createElement("option");
							option.value = sheet;
							option.textContent = sheet;
							sheetSelect.appendChild(option);
						});
						sheetSelect.disabled = false;
					})
					.catch(error => console.error("Error fetching sheets:", error));
			}
		});

		document.getElementById("sheetSelect").addEventListener("change", function (event) {
			const sheetName = event.target.value;
			const file = document.getElementById("excelFileInput").files[0];

			if (file && sheetName) {
				const formData = new FormData();
				formData.append("file", file);
				formData.append("sheetName", sheetName);

				fetch("/Dashboard/GetData", { method: "POST", body: formData })
					.then(response => response.json())
					.then(data => {
						tbody.innerHTML = "";
						data.forEach(employee => {
							const row = document.createElement("tr");
							row.innerHTML = `
								<td>${employee.id}</td>
								<td><a href="#">${employee.name}</a></td>
								<td>${employee.department}</td>
								<td>${employee.holiday}</td>
								<td>${employee.overtime}</td>
								<td>${employee.hoursWorked}</td>
								<td>
									<button class="btn btn-primary btn-view">View</button>
									<button class="btn btn-danger btn-delete">Delete</button>
								</td>
							`;
							tbody.appendChild(row);
						});

						allRows = Array.from(tbody.rows);
						filteredRows = [...allRows];
						showPage(1);
					})
					.catch(error => console.error("Error fetching data:", error));
			}
		});
	});
</script>
